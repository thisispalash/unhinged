# Unhinged lander app
#
# Profiles:
#   dev  :: bind mount + dev server + tailwind watch + host port 8001
#   prod :: baked image + gunicorn, no host port (accessed through nginx)
#
# Usage:
#   COMPOSE_PROFILES=dev docker compose up -d
#   COMPOSE_PROFILES=prod docker compose up -d

services:

  # ---------------- dev ----------------------------------------------------- #
  unhinged_lander:
    container_name: unhinged_lander_dev
    extends:
      file: unhinged-base.yml
      service: unhinged-base
    command: make dev
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=true
      - PG_HOST=${PG_HOST}
      - PG_PORT=${PG_PORT}
      - PG_USER=${PG_USER}
      - PG_PASS=${PG_PASS}
      - PG_DATABASE=${PG_DATABASE}
      - GOATCOUNTER_URL=${GOATCOUNTER_URL:-}
    volumes:
      - .:/unhinged_lander
      - static_volume:/unhinged_lander/staticfiles
    ports:
      - "8001:8000"
    profiles:
      - dev

  # ---------------- prod ---------------------------------------------------- #
  unhinged_lander_prod:
    container_name: unhinged_lander
    extends:
      file: unhinged-base.yml
      service: unhinged-base
    command: make prod
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=false
      - PG_HOST=${PG_HOST}
      - PG_PORT=${PG_PORT}
      - PG_USER=${PG_USER}
      - PG_PASS=${PG_PASS}
      - PG_DATABASE=${PG_DATABASE}
      - GOATCOUNTER_URL=${GOATCOUNTER_URL:-}
    volumes:
      - static_volume:/unhinged_lander/staticfiles
    profiles:
      - prod

networks:
  kdio_network:
    external: true

volumes:
  static_volume:
    name: unhinged_lander_static
